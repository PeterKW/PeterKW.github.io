<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Music Playlist Redirect</title>
  <style>
    body {
      background: #111;
      color: #eee;
      font-family: system-ui, sans-serif;
      text-align: center;
      padding-top: 60px;
    }
    .box {
      display: inline-block;
      background: #222;
      border: 1px solid #444;
      padding: 20px 30px;
      border-radius: 10px;
    }
  </style>
</head>

<body>
  <div class="box">
    <h2>üéµ Music Playlist Redirect</h2>
    <p id="status">Loading‚Ä¶</p>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>

  <script>
  (async () => {

    const status = msg => document.getElementById("status").innerText = msg;

    // 1Ô∏è‚É£ Read key from URL
    const params = new URLSearchParams(window.location.search);
    const key = params.get("key");

    if (!key) {
      status("Missing ?key=");
      return;
    }

    status("Loading playlists‚Ä¶");

    // 2Ô∏è‚É£ Load the encrypted playlist list
    let playlists;
    try {
      const res = await fetch("playlists.json?cache=" + Date.now());
      playlists = await res.json();
    } catch (e) {
      console.error(e);
      status("Failed to load playlists.json");
      return;
    }

    // 3Ô∏è‚É£ Compute SHA256 of key
    const keyhash = "SHA256:" + CryptoJS.SHA256(key).toString();

    // 4Ô∏è‚É£ Find matching entry
    const entry = playlists.find(p => p.keyhash === keyhash);

    if (!entry) {
      status("Playlist not found: " + key);
      return;
    }

    status("Decrypting‚Ä¶");

    // üîë 5Ô∏è‚É£ Master password ‚Äî MUST match GitHub secret
    const MASTER_PASSWORD = "MusicPlaylistRedirect";

    // üîß Helper: derive PBKDF2 key (must match encrypt.js)
    function deriveKey(saltWordArray) {
      return CryptoJS.PBKDF2(MASTER_PASSWORD, saltWordArray, {
        keySize: 256 / 32,
        iterations: 1000,
        hasher: CryptoJS.algo.SHA256
      });
    }

    try {
      const saltWA = CryptoJS.enc.Base64.parse(entry.salt);
      const ivWA   = CryptoJS.enc.Base64.parse(entry.iv);
      const keyWA  = deriveKey(saltWA);

      const cipherParams = CryptoJS.lib.CipherParams.create({
        ciphertext: CryptoJS.enc.Base64.parse(entry.ciphertext)
      });

      const out = CryptoJS.AES.decrypt(cipherParams, keyWA, { iv: ivWA });
      const decrypted = out.toString(CryptoJS.enc.Utf8);

      if (!decrypted || !decrypted.startsWith("http")) {
        console.error("Decrypted:", decrypted);
        status("Decryption failed.");
        return;
      }

      status("Redirecting‚Ä¶");
      window.location.href = decrypted;

    } catch (err) {
      console.error(err);
      status("Decryption error.");
    }

  })();
  </script>

</body>
</html>
