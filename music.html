<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Playlist Redirect</title>
<style>
  body {
    background: #111;
    color: #eee;
    font-family: Arial, sans-serif;
    text-align: center;
    padding-top: 60px;
  }
  .box {
    background: #222;
    border: 1px solid #444;
    padding: 20px;
    display: inline-block;
    border-radius: 10px;
    max-width: 90%;
  }
  a { color: #9cf; }
</style>
</head>

<body>
<div class="box">
  <h2>Music Playlist Redirect</h2>
  <p id="msg">Loading…</p>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script>
(async () => {
  const msg = t => document.getElementById("msg").innerText = t;

  const params = new URLSearchParams(window.location.search);
  const key = params.get("key");

  if (!key) {
    msg("No playlist key provided.");
    return;
  }

  msg("Loading playlists…");

  // Load encrypted playlists.json
  let playlists;
  try {
    const res = await fetch("playlists.json?cache=" + Date.now());
    playlists = await res.json();
  } catch (e) {
    msg("Failed to load playlists.json");
    console.error(e);
    return;
  }

  // Match encrypted entry by hashing the key
  const keyhash = "SHA256:" + CryptoJS.SHA256(key).toString();
  const entry = playlists.find(p => p.keyhash === keyhash);

  if (!entry) {
    msg("Playlist not found: " + key);
    return;
  }

  msg("Decrypting…");

  const salt = CryptoJS.enc.Base64.parse(entry.salt);
  const iv = CryptoJS.enc.Base64.parse(entry.iv);

  // Master password used by GitHub Action
  const MASTER_PASSWORD = "MusicPlaylistRedirect";

  let decrypted;
  try {
    const out = CryptoJS.AES.decrypt(entry.ciphertext, MASTER_PASSWORD, { iv, salt });
    decrypted = out.toString(CryptoJS.enc.Utf8);
  } catch (e) {
    msg("Decryption error.");
    console.error(e);
    return;
  }

  if (!decrypted || !decrypted.startsWith("http")) {
    msg("Decryption failed.");
    console.log("Decrypted output:", decrypted);
    return;
  }

  msg("Redirecting…");
  window.location.href = decrypted;

})();
</script>

</body>
</html>
