<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Music Playlist Redirect</title>
  <style>
    body {
      background: #111;
      color: #eee;
      font-family: system-ui, sans-serif;
      text-align: center;
      padding-top: 60px;
    }
    .box {
      display: inline-block;
      background: #222;
      border: 1px solid #444;
      padding: 20px 30px;
      border-radius: 10px;
    }
  </style>
</head>

<body>
  <div class="box">
    <h2>ðŸŽµ Music Playlist Redirect</h2>
    <p id="status">Loadingâ€¦</p>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
  <script>
  (async () => {

    const status = msg =>
      document.getElementById("status").innerText = msg;

    const params = new URLSearchParams(window.location.search);
    const key = params.get("key");

    if (!key) {
      status("Missing ?key=");
      return;
    }

    status("Loading playlistsâ€¦");

    let playlists;
    try {
      const res = await fetch("playlists.json?cache=" + Date.now());
      playlists = await res.json();
    } catch {
      status("Failed to load playlists.json");
      return;
    }

    const keyhash = "SHA256:" + CryptoJS.SHA256(key).toString();
    const entry = playlists.find(p => p.keyhash === keyhash);

    if (!entry) {
      status("Playlist not found");
      return;
    }

    status("Decryptingâ€¦");

    try {
      const saltWA = CryptoJS.enc.Base64.parse(entry.salt);
      const ivWA   = CryptoJS.enc.Base64.parse(entry.iv);

      const derivedKey = CryptoJS.PBKDF2(key, saltWA, {
        keySize: 256 / 32,
        iterations: 1000,
        hasher: CryptoJS.algo.SHA256
      });

      const cipherParams = CryptoJS.lib.CipherParams.create({
        ciphertext: CryptoJS.enc.Base64.parse(entry.ciphertext)
      });

      const out = CryptoJS.AES.decrypt(cipherParams, derivedKey, { iv: ivWA });
      const decrypted = out.toString(CryptoJS.enc.Utf8);

      if (!decrypted || !decrypted.startsWith("http")) {
        status("Decryption failed");
        return;
      }

      status("Redirectingâ€¦");
      window.location.href = decrypted;

    } catch (err) {
      console.error(err);
      status("Decryption error");
    }

  })();
  </script>
</body>
</html>