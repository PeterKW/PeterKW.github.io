<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Playlist Redirect</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0b1020;
      color: #f5f5f5;
      padding: 1.5rem;
      line-height: 1.6;
    }
    .card {
      max-width: 520px;
      margin: 0 auto;
      padding: 1.5rem;
      border-radius: 12px;
      background: #181c30;
      box-shadow: 0 10px 30px rgba(0,0,0,0.45);
    }
    .status {
      margin-top: 0.75rem;
      font-size: 0.95rem;
      opacity: 0.9;
    }
    input[type=password] {
      width: 100%;
      padding: 0.6rem;
      margin-top: 0.8rem;
      font-size: 1rem;
      border-radius: 8px;
      border: none;
      background: #0f1425;
      color: #fff;
    }
    button {
      margin-top: 1rem;
      padding: 0.6rem 1rem;
      font-size: 1rem;
      border: none;
      border-radius: 8px;
      background: #3a4af0;
      color: #fff;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="card">
    <p class="status" id="status">Loading…</p>

    <div id="pwBox" style="display:none;">
      <p style="opacity:0.8; font-size:0.85rem;">
        Enter your playlist code:
      </p>
      <input type="password" id="pwInput" placeholder="Enter key…">
      <button onclick="submitPassword()">Unlock</button>
    </div>
  </div>

  <script>
    async function sha256(text) {
      const enc = new TextEncoder().encode(text);
      const digest = await crypto.subtle.digest("SHA-256", enc);
      return Array.from(new Uint8Array(digest))
        .map(b => b.toString(16).padStart(2,"0"))
        .join("");
    }

    function getParam(name) {
      return new URLSearchParams(window.location.search).get(name);
    }

    function base64ToBytes(b64) {
      return Uint8Array.from(atob(b64), c => c.charCodeAt(0));
    }

    async function decryptEntry(aesKey, entry) {
      const iv = base64ToBytes(entry.iv);
      const data = base64ToBytes(entry.ciphertext);

      const cipher = await crypto.subtle.importKey(
        "raw",
        aesKey,
        "AES-GCM",
        false,
        ["decrypt"]
      );

      const plaintext = await crypto.subtle.decrypt(
        { name: "AES-GCM", iv },
        cipher,
        data
      );

      return new TextDecoder().decode(plaintext);
    }

    async function unlockWithKey(userKey) {
      const statusEl = document.getElementById("status");

      const hashedKey = "sha256:" + await sha256(userKey);

      const resp = await fetch("playlists.json");
      const entries = await resp.json();

      const aesKey = await crypto.subtle.digest("SHA-256", new TextEncoder().encode("MusicPlaylistRedirect"));

      for (const entry of entries) {
        if (entry.keyhash === hashedKey) {
          try {
            const url = await decryptEntry(aesKey, entry);
            statusEl.textContent = "Match found. Redirecting…";
            window.location.href = url;
            return;
          } catch (e) {}
        }
      }

      statusEl.textContent = "No playlist matched this key.";
    }

    async function submitPassword() {
      const key = document.getElementById("pwInput").value.trim();
      if (key) unlockWithKey(key);
    }

    (async function init() {
      const statusEl = document.getElementById("status");

      const key = getParam("key");
      if (key) {
        statusEl.textContent = "Trying key…";
        await unlockWithKey(key);
      } else {
        statusEl.textContent = "Enter playlist key.";
        document.getElementById("pwBox").style.display = "block";
      }
    })();
  </script>
</body>
</html>
